#!/usr/bin/env bash
set -e

repo_name="$1"

if [ -z "$repo_name" ]; then
  echo "Usage: $0 <repo_name>"
  exit 1
fi

# Clone the repo
gh repo clone $repo_name

# Parsing the repo name
repo_name=$(echo $repo_name | sed 's/.*github.com\///g') # Remove everything before github.com
repo_name=$(echo $repo_name | sed 's/\.git//g') # Remove .git if present
repo_name=$(echo $repo_name | sed 's/.*\///g') # Remove everything before the last slash

echo "ðŸš€ Setting up $repo_name ðŸš€"

# Change into the repo directory
cd $repo_name

# Check if repo has a makefile
if [ -f Makefile ]; then
    echo "ðŸ“œ Makefile Detected ðŸ“œ"

    # Check if make is installed
    if ! command -v make &> /dev/null
    then
        echo "ðŸš¨ Make is not installed ðŸš¨"
        echo "âŒ Please install make and try again âŒ"
    fi

    echo "ðŸ¤·â€â™€ï¸ Checking if Makefile has a setup command ðŸ¤·â€â™€ï¸"

    # Check if Makefile has a setup command
    if grep -q "setup" Makefile; then
        echo "ðŸ‘ Makefile has a setup command ðŸ‘"
        make setup
    else
        echo "ðŸ‘Ž Makefile does not have a setup command ðŸ‘Ž"
    fi

    echo "ðŸ¤·â€â™€ï¸ Checking if Makefile has a install command ðŸ¤·â€â™€ï¸"

    # Check if Makefile has a install command
    if grep -q "install" Makefile; then
        echo "ðŸ‘ Makefile has a install command ðŸ‘"
        make install
    else
        echo "ðŸ‘Ž Makefile does not have a install command ðŸ‘Ž"
    fi
fi

# Check if repo has a package.json file
if [ -f package.json ]; then
    # Install dependencies
    echo "âœ¨ Node Project Detected âœ¨"

    # Check if yarn.lock exists
    if [ -f yarn.lock ]; then
        echo "ðŸ§¶ Installing dependencies with yarn ðŸ§¶"
        
        # Check if yarn is installed
        if ! command -v yarn &> /dev/null
        then
            echo "ðŸš¨ Yarn is not installed ðŸš¨"
            echo "âŒ Please install yarn and try again âŒ"
        fi

        yarn
    elif [ -f pnpm-lock.yaml ]; then
        echo "ðŸ“¦ Installing dependencies with pnpm ðŸ“¦"
        
        # Check if npm is installed
        if ! command -v pnpm &> /dev/null
        then
            echo "ðŸš¨ pnpm is not installed ðŸš¨"
            echo "âŒ Please install pnpm and try again âŒ"
        fi

        pnpm install
    else
        echo "ðŸ“¦ Installing dependencies with npm ðŸ“¦"

        # Check if npm is installed
        if ! command -v npm &> /dev/null
        then
            echo "ðŸš¨ npm is not installed ðŸš¨"
            echo "âŒ Please install npm and try again âŒ"
        fi

        npm install
    fi
fi

# Check if the project has a go.mod file
if [ -f go.mod ]; then
    echo "ðŸ¹ Go Project Detected ðŸ¹"

    # Check if go is installed
    if ! command -v go &> /dev/null
    then
        echo "ðŸš¨ Go is not installed ðŸš¨"
        echo "âŒ Please install go and try again âŒ"
    fi

    go mod download
fi

# Check if the project has a Gemfile file
if [ -f Gemfile ]; then
    echo "ðŸ’Ž Ruby Project Detected ðŸ’Ž"

    # Check if ruby is installed
    if ! command -v ruby &> /dev/null
    then
        echo "ðŸš¨ Ruby is not installed ðŸš¨"
        echo "âŒ Please install ruby and try again âŒ"
    fi

    if ! command -v bundle &> /dev/null
    then
        echo "ðŸš¨ bundle is not installed ðŸš¨"
        echo "âŒ Please install bundle and try again âŒ"
    fi

    bundle install
fi

# Check if the project has a requirements.txt or setup.py file
if [ -f requirements.txt ]; then
    echo "ðŸ Python Project Detected ðŸ"

    # Check if python is installed
    if ! command -v python &> /dev/null
    then
        echo "ðŸš¨ Python is not installed ðŸš¨"
        echo "âŒ Please install python and try again âŒ"
    fi

    if ! command -v pip &> /dev/null
    then
        echo "ðŸš¨ pip is not installed ðŸš¨"
        echo "âŒ Please install pip and try again âŒ"
    fi
    
    # Check if the project has a setup.py file
    if [ -f setup.py ]; then
        pip install -e .
    else
        pip install -r requirements.txt
    fi
fi

# Check if the project has a composer.json file
if [ -f composer.json ]; then
    echo "ðŸŽ¼ PHP Project Detected ðŸŽ¼"

    # Check if php is installed
    if ! command -v php &> /dev/null
    then
        echo "ðŸš¨ PHP is not installed ðŸš¨"
        echo "âŒ Please install php and try again âŒ"
    fi

    if ! command -v composer &> /dev/null
    then
        echo "ðŸš¨ composer is not installed ðŸš¨"
        echo "âŒ Please install composer and try again âŒ"
    fi

    composer install
fi

# Check if the project has a mix.exs file
if [ -f mix.exs ]; then
    echo "ðŸ”® Elixir Project Detected ðŸ”®"

    # Check if elixir is installed
    if ! command -v elixir &> /dev/null
    then
        echo "ðŸš¨ Elixir is not installed ðŸš¨"
        echo "âŒ Please install elixir and try again âŒ"
    fi

    if ! command -v mix &> /dev/null
    then
        echo "ðŸš¨ mix is not installed ðŸš¨"
        echo "âŒ Please install mix and try again âŒ"
    fi

    mix deps.get
fi

# Check if the project has a pom.xml file
if [ -f pom.xml ]; then
    echo "â˜•ï¸ Java Project Detected â˜•ï¸"

    # Check if java is installed
    if ! command -v java &> /dev/null
    then
        echo "ðŸš¨ Java is not installed ðŸš¨"
        echo "âŒ Please install java and try again âŒ"
    fi

    if ! command -v mvn &> /dev/null
    then
        echo "ðŸš¨ mvn is not installed ðŸš¨"
        echo "âŒ Please install mvn and try again âŒ"
    fi

    mvn install
fi

# Check if the project has a build.gradle file
if [ -f build.gradle ]; then
    echo "ðŸ“¦ Gradle Project Detected ðŸ“¦"

    # Check if gradle is installed
    if ! command -v gradle &> /dev/null
    then
        echo "ðŸš¨ Gradle is not installed ðŸš¨"
        echo "âŒ Please install gradle and try again âŒ"
    fi

    if ! command -v gradle &> /dev/null
    then
        echo "ðŸš¨ gradle is not installed ðŸš¨"
        echo "âŒ Please install gradle and try again âŒ"
    fi

    gradle build
fi

# Check if the project has a cargo.toml file
if [ -f cargo.toml ]; then
    echo "ðŸ¦€ Rust Project Detected ðŸ¦€"

    # Check if rust is installed
    if ! command -v rustc &> /dev/null
    then
        echo "ðŸš¨ Rust is not installed ðŸš¨"
        echo "âŒ Please install rust and try again âŒ"
    fi

    if ! command -v cargo &> /dev/null
    then
        echo "ðŸš¨ cargo is not installed ðŸš¨"
        echo "âŒ Please install cargo and try again âŒ"
    fi

    cargo build
fi

# Print success message
echo "âœ… Setup Done! âœ…"

# Check if 'code' or 'code-insiders' is installed
if ! command -v code &> /dev/null
then
    if ! command -v code-insiders &> /dev/null
    then
        echo "ðŸš¨ VSCode/VSCode Insiders is not installed ðŸš¨"
        echo "âŒ Please install VSCode and try again âŒ"
    fi
fi

# Ask user if they want to open the project in VSCode or VSCode Insiders
read -p "ðŸ‘€ Do you want to open the project in VSCode or VSCode Insiders? (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]
then
    # Check if 'code' is installed
    if command -v code &> /dev/null
    then
        code .
    else
        code-insiders .
    fi
fi

echo "ðŸŽ‰ Happy Coding! ðŸŽ‰"